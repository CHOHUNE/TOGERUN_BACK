name: Java CI/CD with Gradle

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

# ê¸°ë³¸ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/spring
  API_DOMAIN: api.togerun.shop
  EMAIL: ${{ secrets.EMAIL }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # ë°°í¬ ì‹œì‘ ì•Œë¦¼
      - name: Notify Deploy Start
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "attachments": [{
                "color": "#36a64f",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "ğŸš€ *ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤*\n\n*Branch:* ${{ github.ref }}\n*Trigger:* ${{ github.event_name }}\n*Commit Message:* ${{ github.event.head_commit.message }}"
                    }
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
        if: success()

      # Step 1: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Java ê°œë°œ í™˜ê²½ ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Step 3: application.yml íŒŒì¼ ìƒì„± ë° ê²€ì¦
      - name: Create and verify application.yml
        run: |
          mkdir -p ./src/main/resources
          cd ./src/main/resources
          echo "${{ secrets.APPLICATION_YML }}" | base64 -d > application.yml
          echo "Created application.yml:"
          cat application.yml

      # Step 4: Gradle ì„¤ì •
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5

      # Step 5: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant Execute Permission For Gradlew
        run: chmod +x gradlew

      # Step 6: Gradle ë¹Œë“œ ì‹¤í–‰
      - name: Build with Gradle
        run: ./gradlew build --info

      # Step 7: Gradle ë¹Œë“œ ê²°ê³¼ ì•Œë¦¼
      - name: Notify Build Result
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "attachments": [{
                "color": "${{ job.status == 'success' && '#36a64f' || '#dc3545' }}",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "${{ job.status == 'success' && 'âœ… *ë¹Œë“œ ì„±ê³µ*' || 'âŒ *ë¹Œë“œ ì‹¤íŒ¨*' }}\n\n*Image:* ${{ env.DOCKER_IMAGE }}:latest\n*Build Time:* ${{steps.current-time.outputs.formattedTime}}"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ë³€ê²½ì‚¬í•­:*\n```${{ github.event.head_commit.message }}```"
                    }
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
        if: always()

      # Step 8: Docker ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
      - name: Create build context
        run: |
          mkdir -p docker-build
          EXEC_JAR=$(find build/libs/ -name "*.jar" -not -name "*plain.jar" -type f)
          
          if [ -z "$EXEC_JAR" ]; then
            echo "Error: No executable JAR file found"
            exit 1
          fi
          
          echo "Found executable JAR: $EXEC_JAR"
          cp "$EXEC_JAR" docker-build/app.jar
          cp Dockerfile docker-build/

      # Step 9: DockerHub ë¡œê·¸ì¸
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 10: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: docker-build
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/spring:latest

      # Step 11: ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
      - name: Create deployment package
        run: |
          mkdir -p deploy
          mkdir -p deploy/nginx/conf.d
          
          # Docker ê´€ë ¨ íŒŒì¼ ë³µì‚¬
          cp -r docker-build/* deploy/
          cp docker-compose.blue.yml deploy/
          cp docker-compose.green.yml deploy/
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p deploy/scripts
          mkdir -p deploy/nginx
          
          # nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
          cp nginx.conf deploy/nginx/
          cp blue.conf deploy/nginx/conf.d/
          cp green.conf deploy/nginx/conf.d/
          
          # í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸ ë° ë³µì‚¬
          required_files=(
            "scripts/common.sh"
            "scripts/before_install.sh"
            "scripts/start_application.sh"
            "scripts/validate_service.sh"
            "appspec.yml"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: Required file $file not found"
              exit 1
            fi
          
            if [[ $file == scripts/* ]]; then
              cp "$file" deploy/scripts/
            else
              cp "$file" deploy/
            fi
          done
          
          echo "All required files copied successfully"

          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat << 'EOF' > deploy/scripts/set_environment.sh
          #!/bin/bash
          
          # ì•± ë””ë ‰í† ë¦¬ ì„¤ì •
          APP_DIR="/home/ubuntu/app"
          
          # ë¡œê·¸ íŒŒì¼ ì„¤ì •
          LOG_FILE="/home/ubuntu/app/logs/deployment.log"
          
          # ë¡œê¹… í•¨ìˆ˜
          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }
          
          # ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
          log "Creating app directory if not exists..."
          mkdir -p "$APP_DIR"
          mkdir -p "$APP_DIR/nginx"
          mkdir -p "$APP_DIR/logs"
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          log "Creating environment file..."
          cat > "$APP_DIR/.env" << ENVEOF
          APP_DIR=/home/ubuntu/app
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
          ENVEOF
          
          # íŒŒì¼ ê¶Œí•œ ë° ì†Œìœ ê¶Œ ì„¤ì •
          log "Setting file permissions..."
          chown ubuntu:ubuntu "$APP_DIR/.env"
          chmod 600 "$APP_DIR/.env"
          chmod 755 "$APP_DIR/nginx"
          chmod 644 "$APP_DIR/nginx/*.conf"
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
          echo "Verifying .env file creation:"
          ls -l "$APP_DIR/.env"
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë‚´ìš© í™•ì¸ (ê°’ ì œì™¸)
          log "Environment file contents (without values):"
          grep -v '^#' "$APP_DIR/.env" | cut -d'=' -f1
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ê²€ì¦
          if [ ! -f "$APP_DIR/.env" ]; then
            log "Error: Failed to create .env file"
            exit 1
          fi
          
          log "Environment setup completed successfully"
          exit 0
          EOF
          
          # SSL ì¸ì¦ì„œ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
          mkdir -p deploy/certbot/conf
          mkdir -p deploy/certbot/www
          mkdir -p deploy/ssl
          
          # ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x deploy/scripts/*.sh
          
          # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          echo "Verifying deployment files:"
          ls -la deploy/
          echo "Verifying scripts:"
          ls -la deploy/scripts/
          echo "Verifying nginx configs:"
          ls -la deploy/nginx/
          
          # ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
          cd deploy && zip -r ../deploy.zip .

      # Step 12: AWS ìê²© ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Step 13: S3ì— ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
      - name: Upload to S3
        run: |
          aws s3 cp deploy.zip s3://${{ secrets.S3_BUCKET_NAME }}/deploy.zip

      # Step 14: CodeDeploy ë°°í¬ ì‹œì‘
      - name: Start CodeDeploy Deployment
        run: |
          aws deploy create-deployment \
            --application-name ${{ secrets.CODE_DEPLOY_APP_NAME }} \
            --deployment-group-name ${{ secrets.CODE_DEPLOY_GROUP_NAME }} \
            --s3-location bucket=${{ secrets.S3_BUCKET_NAME }},bundleType=zip,key=deploy.zip \
            --deployment-config-name CodeDeployDefault.AllAtOnce \
            --file-exists-behavior OVERWRITE

      # Step 15: ìµœì¢… ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      - name: Notify Deploy Result
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "attachments": [{
                "color": "${{ job.status == 'success' && '#36a64f' || '#dc3545' }}",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "${{ job.status == 'success' && 'ğŸ‰ *ë°°í¬ ì™„ë£Œ*' || 'ğŸ’¥ *ë°°í¬ ì‹¤íŒ¨*' }}\n\n*Application:* ${{ secrets.CODE_DEPLOY_APP_NAME }}\n*Environment:* Production\n*Deploy Time:* ${{steps.current-time.outputs.formattedTime}}"
                    }
                  },
                  {
                    "type": "context",
                    "elements": [
                      {
                        "type": "mrkdwn",
                        "text": "*Triggered by:* ${{ github.actor }}"
                      }
                    ]
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
        if: always()

      # Step 16: ë°°í¬ ì‹œê°„ ê¸°ë¡
      - name: Get Current Time
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: YYYY-MM-DDTHH:mm:ss
          utcOffset: "+09:00"

      - name: Print Current Time
        run: echo "Current Time=${{steps.current-time.outputs.formattedTime}}"
        shell: bash